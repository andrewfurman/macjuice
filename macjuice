#!/bin/bash
# macjuice - A unified CLI for interacting with Apple apps on macOS
# https://github.com/andrewfurman/macjuice

set -e

# Get the directory where macjuice is installed (follow symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [[ -L "$SOURCE" ]]; do
    SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ "$SOURCE" != /* ]] && SOURCE="$SCRIPT_DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
SCRIPTS_DIR="$SCRIPT_DIR/scripts"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Version
VERSION="0.1.0"

# Show help
show_help() {
    echo -e "${CYAN}macjuice${NC} v$VERSION - CLI for Apple apps on macOS"
    echo ""
    echo "Usage: macjuice <app> <command> [args...]"
    echo ""
    echo -e "${YELLOW}Available apps:${NC}"
    echo "  mail        Search, read, send emails"
    echo "  notes       Create, list, search notes"
    echo "  calendar    View and create events"
    echo "  messages    Send and read iMessages"
    echo "  music       Control Apple Music playback"
    echo "  contacts    Search and manage contacts"
    echo "  reminders   Manage reminders and tasks"
    echo "  photos      Search and export photos"
    echo "  shortcuts   Run any macOS Shortcut"
    echo "  home        Control HomeKit devices (via Shortcuts)"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo "  macjuice mail accounts"
    echo "  macjuice mail search \"from:boss\""
    echo "  macjuice notes create \"Title\" \"Content\""
    echo "  macjuice calendar today"
    echo "  macjuice messages send \"+15551234567\" \"Hello!\""
    echo "  macjuice messages send \"John Smith\" \"Hey, are you free tonight?\""
    echo "  macjuice music now"
    echo "  macjuice contacts search \"John\""
    echo "  macjuice reminders add \"Buy milk\" \"Groceries\""
    echo "  macjuice shortcuts list"
    echo "  macjuice shortcuts run \"My Shortcut\""
    echo "  macjuice home run \"Lamp On\""
    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  --help, -h     Show this help message"
    echo "  --version, -v  Show version"
    echo ""
    echo "For app-specific help: macjuice <app> --help"
}

# Show version
show_version() {
    echo "macjuice v$VERSION"
}

# Run an AppleScript
run_applescript() {
    local script="$1"
    shift
    local script_path="$SCRIPTS_DIR/$script.applescript"

    if [[ ! -f "$script_path" ]]; then
        echo -e "${RED}Error:${NC} Script not found: $script_path" >&2
        exit 1
    fi

    osascript "$script_path" "$@"
}

# Show app-specific help
show_app_help() {
    local app="$1"

    case "$app" in
        mail)
            echo -e "${CYAN}macjuice mail${NC} - Email management"
            echo ""
            echo "Commands:"
            echo "  accounts              List all mail accounts"
            echo "  list [mailbox]        List recent emails (default: INBOX)"
            echo "  search <query>        Search emails"
            echo "  read <message-id>     Read a specific email"
            echo "  send <to> <subj> <body>  Send an email"
            echo "  draft <to> <subj> <body> Save a draft email"
            echo "  delete-draft <id>     Delete a draft by message ID"
            echo "  reply <id> <body>     Reply to a message (saves as draft)"
            echo ""
            echo "Draft options:"
            echo "  --account <name>      Send from a specific account"
            echo "  --cc <emails>         Add CC recipients (comma-separated)"
            echo "  --bcc <emails>        Add BCC recipients (comma-separated)"
            echo ""
            echo "Reply options:"
            echo "  --search <query>      Find message by subject/sender instead of ID"
            echo "  --from <email>        Send from a specific account"
            echo "  --cc <emails>         Add CC recipients (comma-separated)"
            echo "  --bcc <emails>        Add BCC recipients (comma-separated)"
            ;;
        notes)
            echo -e "${CYAN}macjuice notes${NC} - Notes management"
            echo ""
            echo "Commands:"
            echo "  list                  List all notes"
            echo "  folders               List all folders"
            echo "  create <title> <body> Create a new note"
            echo "  read <title>          Read a note"
            echo "  search <query>        Search notes"
            ;;
        calendar)
            echo -e "${CYAN}macjuice calendar${NC} - Calendar management"
            echo ""
            echo "Commands:"
            echo "  list                  List all calendars"
            echo "  today                 Show today's events"
            echo "  week                  Show this week's events"
            echo "  upcoming [days]       Show upcoming events (default: 7 days)"
            echo "  search <query>        Search events"
            echo "  create <title> <date> <duration> [calendar]"
            echo "                        Create an event"
            echo "  delete <title>        Delete an event"
            ;;
        messages)
            echo -e "${CYAN}macjuice messages${NC} - iMessage/SMS"
            echo ""
            echo "Commands:"
            echo "  chats                 List all chats"
            echo "  send <to> <message>   Send a message (phone, email, or contact name)"
            echo "  read <chat> [count]   Read messages from a chat"
            echo "  recent [count]        Show recent messages"
            echo "  search <query>        Search messages"
            ;;
        music)
            echo -e "${CYAN}macjuice music${NC} - Apple Music control"
            echo ""
            echo "Commands:"
            echo "  play [playlist]       Start playback (optionally from a playlist)"
            echo "  pause                 Pause playback"
            echo "  toggle                Toggle play/pause"
            echo "  next                  Next track"
            echo "  previous              Previous track"
            echo "  now                   Show current track"
            echo "  volume [level]        Get/set volume (0-100)"
            echo "  playlists             List playlists"
            echo "  search <query>        Search library"
            ;;
        contacts)
            echo -e "${CYAN}macjuice contacts${NC} - Contacts management"
            echo ""
            echo "Commands:"
            echo "  list                  List contacts"
            echo "  search <query>        Search contacts"
            echo "  show <name>           Show contact details"
            echo "  groups                List contact groups"
            echo "  add <first> <last> [email] [phone]"
            echo "                        Add a new contact"
            echo "  email <name>          Get contact's email"
            echo "  phone <name>          Get contact's phone"
            ;;
        reminders)
            echo -e "${CYAN}macjuice reminders${NC} - Reminders management"
            echo ""
            echo "Commands:"
            echo "  lists                 List all reminder lists"
            echo "  list [listname]       List reminders in a list"
            echo "  all                   List all incomplete reminders"
            echo "  today                 List reminders due today"
            echo "  overdue               List overdue reminders"
            echo "  add <title> [list] [due]"
            echo "                        Add a reminder"
            echo "  complete <title>      Mark reminder as complete"
            echo "  delete <title>        Delete a reminder"
            echo "  search <query>        Search reminders"
            ;;
        photos)
            echo -e "${CYAN}macjuice photos${NC} - Apple Photos"
            echo ""
            echo "Commands:"
            echo "  recent [count]        List recent photos (default: 20)"
            echo "  search <query>        Search by filename or description"
            echo "  albums                List all albums"
            echo "  export <query> <dir>  Export matching photos to a folder"
            echo "  export-recent <n> <dir>  Export N recent photos"
            ;;
        shortcuts)
            echo -e "${CYAN}macjuice shortcuts${NC} - Run macOS Shortcuts"
            echo ""
            echo "Commands:"
            echo "  list                  List all shortcuts"
            echo "  run <name>            Run a shortcut by name"
            echo "  search <query>        Search shortcuts by name"
            echo ""
            echo "Run any shortcut you've created in the Shortcuts app."
            echo "First run will prompt for Automation permission."
            ;;
        home)
            echo -e "${CYAN}macjuice home${NC} - HomeKit control (via Shortcuts)"
            echo ""
            echo "Commands:"
            echo "  list                  List HomeKit shortcuts"
            echo "  run <shortcut>        Run a HomeKit shortcut"
            echo "  setup                 Set up HomeKit shortcuts"
            echo ""
            echo "HomeKit has no direct CLI access, so macjuice uses Shortcuts"
            echo "as a bridge. Create shortcuts in the Shortcuts app that control"
            echo "your HomeKit devices, then run them here."
            echo ""
            echo "See: macjuice home setup"
            ;;
        *)
            echo -e "${RED}Error:${NC} Unknown app: $app"
            echo "Run 'macjuice --help' for available apps."
            exit 1
            ;;
    esac
}

# Main entry point
main() {
    # Handle no arguments
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi

    # Handle global flags
    case "$1" in
        --help|-h)
            show_help
            exit 0
            ;;
        --version|-v)
            show_version
            exit 0
            ;;
    esac

    # Get the app name
    local app="$1"
    shift

    # Handle app-specific help
    if [[ $# -eq 0 ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
        show_app_help "$app"
        exit 0
    fi

    # Get the command
    local cmd="$1"
    shift

    # Route to the appropriate AppleScript
    case "$app" in
        messages)
            # Messages: SQLite for reads (fast), AppleScript only for sending
            case "$cmd" in
                chats|read|recent|search|info)
                    bash "$SCRIPTS_DIR/messages-db.sh" "$cmd" "$@"
                    ;;
                send|send-sms|unread)
                    run_applescript "messages" "$cmd" "$@"
                    ;;
                *)
                    # Show messages help for unknown commands
                    bash "$SCRIPTS_DIR/messages-db.sh" "help"
                    ;;
            esac
            ;;
        mail)
            case "$cmd" in
                draft)
                    # Parse: macjuice mail draft <to> <subject> <body> [--account <name>] [--cc <cc>] [--bcc <bcc>] [--reply-to <id>]
                    if [[ $# -lt 3 ]]; then
                        echo -e "${RED}Error:${NC} draft requires <to> <subject> <body>"
                        echo "Usage: macjuice mail draft <to> <subject> <body> [--account <name>] [--cc <cc>] [--bcc <bcc>] [--reply-to <message-id>]"
                        exit 1
                    fi
                    local to_addr="$1" subject="$2" body="$3"
                    shift 3
                    local account="" cc="" bcc="" reply_to=""
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            --account) account="$2"; shift 2 ;;
                            --cc)      cc="$2"; shift 2 ;;
                            --bcc)     bcc="$2"; shift 2 ;;
                            --reply-to) reply_to="$2"; shift 2 ;;
                            *)         shift ;;
                        esac
                    done

                    local args=("$to_addr" "$subject" "$body")
                    [[ -n "$account" ]] && args+=("--from=$account")
                    [[ -n "$cc" ]] && args+=("--cc=$cc")
                    [[ -n "$bcc" ]] && args+=("--bcc=$bcc")
                    run_applescript "mail" "draft" "${args[@]}"
                    ;;
                reply)
                    # Parse: macjuice mail reply <message-id-or-search> <body> [--from=email] [--cc=emails] [--bcc=emails]
                    if [[ $# -lt 2 ]]; then
                        echo -e "${RED}Error:${NC} reply requires <message-id> <body>"
                        echo "Usage: macjuice mail reply <message-id> <body> [--from=email] [--cc=a@x.com,b@x.com] [--bcc=c@x.com]"
                        echo "       macjuice mail reply --search <query> <body> [--from=email] [--cc=emails] [--bcc=emails]"
                        exit 1
                    fi

                    local from_flag="" cc="" bcc=""
                    local search_mode=false
                    local msg_id=""
                    local body=""

                    # Check for --search mode
                    if [[ "$1" == "--search" ]]; then
                        search_mode=true
                        shift
                        if [[ $# -lt 2 ]]; then
                            echo -e "${RED}Error:${NC} --search requires <query> <body>"
                            exit 1
                        fi
                        local query="$1"
                        body="$2"
                        shift 2

                        # Search for the message, take the first result
                        local search_result
                        search_result=$(run_applescript "mail" "search" "$query")
                        if [[ "$search_result" == "No messages found"* ]]; then
                            echo -e "${RED}Error:${NC} $search_result"
                            exit 1
                        fi
                        # First line, first field (ID) before the " | "
                        msg_id=$(echo "$search_result" | head -1 | cut -d'|' -f1 | xargs)
                        echo -e "${BLUE}Found:${NC} $(echo "$search_result" | head -1)"
                    else
                        msg_id="$1"
                        body="$2"
                        shift 2
                    fi

                    # Parse optional flags
                    while [[ $# -gt 0 ]]; do
                        case "$1" in
                            --from=*) from_flag="${1#--from=}"; shift ;;
                            --from)   from_flag="$2"; shift 2 ;;
                            --cc=*)   cc="${1#--cc=}"; shift ;;
                            --cc)     cc="$2"; shift 2 ;;
                            --bcc=*)  bcc="${1#--bcc=}"; shift ;;
                            --bcc)    bcc="$2"; shift 2 ;;
                            *)        shift ;;
                        esac
                    done

                    local args=("$msg_id" "$body")
                    [[ -n "$from_flag" ]] && args+=("--from=$from_flag")
                    [[ -n "$cc" ]] && args+=("--cc=$cc")
                    [[ -n "$bcc" ]] && args+=("--bcc=$bcc")
                    run_applescript "mail" "reply" "${args[@]}"
                    ;;
                delete-draft)
                    # Parse: macjuice mail delete-draft <message-id>
                    if [[ $# -lt 1 ]]; then
                        echo -e "${RED}Error:${NC} delete-draft requires a message ID"
                        echo "Usage: macjuice mail delete-draft <message-id>"
                        echo "       Use 'macjuice mail list Drafts' to find draft message IDs."
                        exit 1
                    fi
                    local msg_id="$1"
                    run_applescript "mail" "delete-draft" "$msg_id"
                    ;;
                *)
                    run_applescript "mail" "$cmd" "$@"
                    ;;
            esac
            ;;
        photos)
            case "$cmd" in
                search)
                    # SQLite-based search (fast, handles 166K+ photos)
                    if [[ $# -lt 1 ]]; then
                        echo -e "${RED}Error:${NC} search requires a query"
                        echo "Usage: macjuice photos search <query>"
                        exit 1
                    fi
                    python3 "$SCRIPTS_DIR/photos_search.py" "$@"
                    ;;
                *)
                    run_applescript "photos" "$cmd" "$@"
                    ;;
            esac
            ;;
        calendar)
            case "$cmd" in
                list|today|week|upcoming|search)
                    python3 "$SCRIPTS_DIR/calendar_read.py" "$cmd" "$@"
                    ;;
                *)
                    run_applescript "calendar" "$cmd" "$@"
                    ;;
            esac
            ;;
        notes|music|contacts|reminders|shortcuts)
            run_applescript "$app" "$cmd" "$@"
            ;;
        home)
            if [[ "$cmd" == "setup" ]]; then
                # Run the setup script
                bash "$SCRIPTS_DIR/home-setup.sh"
            else
                run_applescript "home" "$cmd" "$@"
            fi
            ;;
        facetime)
            # FaceTime uses URL scheme, not AppleScript
            case "$cmd" in
                call|video)
                    open "facetime://$1"
                    echo "Opening FaceTime call to $1"
                    ;;
                audio)
                    open "facetime-audio://$1"
                    echo "Opening FaceTime audio call to $1"
                    ;;
                *)
                    open "facetime://$cmd"
                    echo "Opening FaceTime call to $cmd"
                    ;;
            esac
            ;;
        *)
            echo -e "${RED}Error:${NC} Unknown app: $app"
            echo "Run 'macjuice --help' for available apps."
            exit 1
            ;;
    esac
}

# Run main
main "$@"
